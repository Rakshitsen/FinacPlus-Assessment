// Scripted Pipeline for FinacPlus Assessment
// CI/CD: Git → Jenkins → Docker Hub → Kubernetes (kind cluster)

node {
    // ---------- 1. Initialize ----------
    // Variables for image name, tags, and credentials
    def IMAGE_REPO = "rakshitsen/simple-app"
    def TAG = "${BUILD_NUMBER}"
    def REGISTRY_CREDS = "Docker_cred"
    def KUBECONFIG_FILE = "KUBECONFIG_FILE"
    def DEPLOYMENT_FILE = "k8s/deployment.yml"

    stage('Checkout Source') {
        // Pull latest code from main branch
        checkout scm
    }

    // ---------- 2. Build ----------
    stage('Build & Test') {
        sh '''
            echo "Installing dependencies and running quick tests..."
            python3 --version
            docker --version
        '''
    }

    // ---------- 3. Build Docker Image ----------
    stage('Build Docker Image') {
        sh """
            echo "Building Docker image ${IMAGE_REPO}:${TAG}"
            docker build -t ${IMAGE_REPO}:${TAG} .
            docker tag ${IMAGE_REPO}:${TAG} ${IMAGE_REPO}:latest
        """
    }

    // ---------- 4. Push to Docker Hub ----------
    stage('Push Image to Registry') {
        withCredentials([usernamePassword(credentialsId: REGISTRY_CREDS, usernameVariable: 'USER', passwordVariable: 'PASS')]) {
            withEnv(["DOCKER_CONFIG=${env.WORKSPACE}/.docker-tmp","IMAGE_REPO=${IMAGE_REPO}", "TAG=${TAG}"]) {
                sh """#!/usr/bin/env bash
                    set -euo pipefail
                    mkdir -p "\$DOCKER_CONFIG"
                    printf "%s" "\$PASS" | docker login -u "\$USER" --password-stdin
                    docker push "${IMAGE_REPO}:${TAG}"
                    docker tag "${IMAGE_REPO}:${TAG}" "${IMAGE_REPO}:latest"
                    docker push "${IMAGE_REPO}:latest"
                    docker logout || true
                    rm -rf "\$DOCKER_CONFIG"
                """
            }
        }
    }
    // ---------- 5. Deploy to Kubernetes ----------
stage('Deploy to Kubernetes') {
    withCredentials([file(credentialsId: KUBECONFIG_FILE, variable: 'KUBECONFIG_PATH')]) {
        sh """
            echo "Updating deployment image..."
            if kubectl --kubeconfig $KUBECONFIG_PATH get deployment simple-app >/dev/null 2>&1; then
                echo "Deployment exists — updating image"
                kubectl --kubeconfig $KUBECONFIG_PATH set image deployment/simple-app simple-app=${IMAGE_REPO}:${TAG}
            else
                echo "No deployment found — creating new resources"
                kubectl --kubeconfig $KUBECONFIG_PATH apply -f $DEPLOYMENT_FILE
            fi

            echo "Waiting for rollout..."
            kubectl --kubeconfig $KUBECONFIG_PATH rollout status deployment/simple-app
"""

    }
}


    // ---------- 6. Health Verification ----------
    stage('Verify Deployment') {
        withCredentials([file(credentialsId: KUBECONFIG_FILE, variable: 'KUBECONFIG_PATH')]) {
            sh '''
                echo "Port-forwarding and checking /health endpoint..."
                kubectl --kubeconfig $KUBECONFIG_PATH port-forward svc/simple-app-service 7070:80 &
                sleep 5
                STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:7070/health)
                if [ "$STATUS" -ne 200 ]; then
                    echo "Health check failed with status: $STATUS"
                    exit 1
                fi
                echo "Application healthy (HTTP 200)"
            '''
        }
    }


    stage('Deploy to Kubernetes') {
        try {
            withCredentials([file(credentialsId: KUBECONFIG_FILE, variable: 'KUBECONFIG_PATH')]) {
                sh """
                    # echo "Updating image in deployment manifest..."
                    # sed -i 's|image: .*|image: ${IMAGE_REPO}:${TAG}|g' ${DEPLOYMENT_FILE}
                    # echo "Applying updated manifest..."
                    # kubectl --kubeconfig \$KUBECONFIG_PATH apply -f ${DEPLOYMENT_FILE}
                    echo "Updating deployment image..."
                    kubectl --kubeconfig \$KUBECONFIG_PATH set image deployment/simple-app simple-app=${IMAGE_REPO}:${TAG}
                    echo "Waiting for rollout..."
                    kubectl --kubeconfig "\$KUBECONFIG_PATH" rollout status deployment/simple-app
                    echo "Show rollout history..."
                    kubectl --kubeconfig "\$KUBECONFIG_PATH" rollout history deployment/simple-app
                """
            }
        } catch (Exception e) {
            echo "Deployment failed: ${e.message}"
            currentBuild.result = 'FAILURE'
            error("Kubernetes deployment failed")
        }
    }


    // ---------- 7. Cleanup ----------
    stage('Post-Build Cleanup') {
    sh "docker rmi ${IMAGE_REPO}:${TAG} || true"
     cleanWs()
    }
    


} // end of node
